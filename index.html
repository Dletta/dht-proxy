<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Gun DHT - Example use</title>
  </head>
  <body>
    A gun walks into a bar and the barman says "What Protocol do you speak?"
    The gun answers: "Any."

    Send some data via gun
    <br>
    <button onclick="window.gun.get('meshed_data').get('randomNumber').put(Math.random()*100)">Send</button>
    <p id="output">Data from them</p>
  </body>
  <!-- Needed modules -->
  <script src="https://cdn.jsdelivr.net/gh/amark/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/amark/gun/lib/promise.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/dletta/dht-proxy/websocketproxy.js"></script>
  <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
  <!-- Initiate Gun and the module-->
  <script type="module">
  // import for trystero module
  import {joinRoom} from 'https://cdn.skypack.dev/trystero'

  // configure which protocols are wanted to be used
  // the mesh_id identifies which mesh to join
  const configuration = {
    trystero_enabled: true,
    trystero_app_id: "gun_dht",
    trystero_mesh_id: "graph-universal-node",
    peerjs_enabled: false,
    peerjs_mesh_id: "graph-universal-node",
    hyperdht_enabled: false,
    hyperdht_hash: "graph-universal-node" // add hashing function here
  };
  // instantiate module
  var proxy = new GunProxy()
  // configure websocket
  var WebSocketProxy = proxy.initialize(configuration, joinRoom)

  // pass websocket as custom websocket to gun instance
  // make sure localStorage / indexedDB is on
  var gun = Gun({peers:["proxy:websocket"], WebSocket:WebSocketProxy})

  setTimeout(() => {
    proxy.attachGun(gun)
      // We set some initial value here
      // Put your application logic here
    gun.get('meshed_data').get('randomNumber').put(Math.random()*100)


    gun.get('meshed_data').get('randomNumber').on((val, key)=>{
      console.log('Value updated key: ' +key +"; val: " + val)
      var out = document.getElementById('output')
      out.innerText = 'key: ' +key +"; val: " + val + ";"
    })
  }, 1000)


  window.gun = gun
  window.proxy = proxy
  </script>
</html>
